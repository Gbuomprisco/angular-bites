<!doctype html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="icon" href="/favicon.ico"><title>Async Rendering with a single Rx Operator</title><meta name="description" content="Bite-sized resources for Angular and its ecosystem"><meta name="author" content="Giancarlo Buomprisco"><meta property="og:title" content="Async Rendering with a single Rx Operator"><meta property="og:description" content="Bite-sized resources for Angular and its ecosystem"><meta property="og:locale" content="en"><meta property="og:site_name" content="Angular Bites"><meta property="og:type" content="article"><meta property="article:published_time" content="2020-07-11T00:00:00.000Z"><script type="application/ld+json">{
"description": "Bite-sized resources for Angular and its ecosystem",
"author": { "@type": "Person", "name": "Giancarlo Buomprisco" },
"@type": "BlogPosting",
"url": "https://angularbites.com/async-rendering-with-a-single-rx-operator/",
"publisher": {
"@type": "Organization",
"logo": {
"@type": "ImageObject",
"url": "https://angularbites.com/assets/images/logo.png"
},
"name": "Giancarlo Buomprisco"
},
"headline": "Async Rendering with a single Rx Operator",
"datePublished": "2020-07-11T00:00:00.000Z",
"mainEntityOfPage": {
"@type": "WebPage",
"@id": "https://angularbites.com/async-rendering-with-a-single-rx-operator/"
},
"@context": "http://schema.org"
}</script><link href="/assets/styles/main.css" rel="stylesheet"></head><body><div class="container mx-auto pt-8"><header class="mb-8"><h2 class="text-2xl"><a href="/">Angular Bites</a></h2><h2 class="text-lg mb-8 text-gray-800">Bite-sized resources for Angular and its ecosystem</h2></header><article class="post pt-10"><header class="mb-10"><h1 class="text-5xl">Async Rendering with a single Rx Operator</h1><div class="user-image mb-2 flex items-center"><a href="https://twitter.com/@gc_psk" class="flex items-center"><img src="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wCEAA0JCgsKCA0LCgsODg0PEyAVExISEyccHhcgLikxMC4pLSwzOko+MzZGNywtQFdBRkxOUlNSMj5aYVpQYEpRUk8BDg4OExETJhUVJk81LTVPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT//AABEIAAsADAMBEQACEQEDEQH/xAGiAAABBQEBAQEBAQAAAAAAAAAAAQIDBAUGBwgJCgsQAAIBAwMCBAMFBQQEAAABfQECAwAEEQUSITFBBhNRYQcicRQygZGhCCNCscEVUtHwJDNicoIJChYXGBkaJSYnKCkqNDU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6g4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2drh4uPk5ebn6Onq8fLz9PX29/j5+gEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoLEQACAQIEBAMEBwUEBAABAncAAQIDEQQFITEGEkFRB2FxEyIygQgUQpGhscEJIzNS8BVictEKFiQ04SXxFxgZGiYnKCkqNTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqCg4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2dri4+Tl5ufo6ery8/T19vf4+fr/2gAMAwEAAhEDEQA/AMbSrETWF672xkbYPLcrwOvT9K4km2dcWrO5jSRvG5R0ZWHUEYIo9SD1HQUVdJVFUbcdPwFddFe6jKe5x2tqJJbV3GWa2Qk+vWsq6XMvQdN6H//Z" loading="lazy" data-src="/assets/images/giancarlo.jpeg" class="lazyload" width="422" height="388"> <span class="ml-2 text-gray-600 text-sm">@gc_psk</span> </a><span class="text-gray-600 text-400 ml-1">/ July 11, 2020</span></div></header><section class="pt-3 pb-3"><p>The concept of async rendering, in the way I mean it, is simple: the process of rendering items on screen is scattered so that the browser won't block until all items have been rendered.</p><p>So here's how it works: I render item one, then I wait a little bit, then render the next item, and so on. In between, the browser can execute all the other scheduled events in the loop before we let it render again.</p><h3>When and Why you should use it, sometimes</h3><p>When does this work (particularly) well?</p><ul><li>In case we are rendering particularly long and heavy lists</li><li>In case each item of the list takes a lot of space on the page</li></ul><p>Why? Your app will "look" faster. It's not going to be <em>actually</em> faster, but your users will perceive it as being so. Good enough.</p><h3>A single-operator approach</h3><p>In the past I've solved this in various ways, as I described in <a href="https://blog.bitsrc.io/3-ways-to-render-large-lists-in-angular-9f4dcb9b65">How to Render Large Lists in Angular</a>.</p><p>This time I thought of a single operator that would sequentially scatter the rendering process of a subset of the array.</p><p>We'll call this operator <code>lazyArray</code>. It supports two arguments:</p><ul><li><code>delayMs</code> = how long the browser should wait before it renders the next array</li><li><code>concurrency</code> = how many items to render at once</li></ul><p>Just show me the code, Giancarlo!</p><p>Alright, here it is:</p><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">function</span> lazyArray<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><br>  delayMs <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span><br>  concurrency <span class="token operator">=</span> <span class="token number">2</span><br><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">let</span> isFirstEmission <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">source$<span class="token operator">:</span> Observable<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> source$<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><br>      <span class="token function">mergeMap</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">items</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><br>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isFirstEmission<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>          <span class="token keyword">return</span> <span class="token keyword">of</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br><br>        <span class="token keyword">const</span> items$ <span class="token operator">=</span> <span class="token keyword">from</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token keyword">return</span> items$<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><br>          <span class="token function">bufferCount</span><span class="token punctuation">(</span>concurrency<span class="token punctuation">)</span><span class="token punctuation">,</span><br>          <span class="token function">concatMap</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><br>            <span class="token keyword">const</span> delayed <span class="token operator">=</span> <span class="token function">delay</span><span class="token punctuation">(</span>index <span class="token operator">*</span> delayMs<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>            <span class="token keyword">return</span> <span class="token function">scheduled</span><span class="token punctuation">(</span><span class="token keyword">of</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span> animationFrameScheduler<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>delayed<span class="token punctuation">)</span><span class="token punctuation">;</span><br>          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>          <span class="token function">scan</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">acc<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> steps<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><br>            <span class="token keyword">return</span> <span class="token punctuation">[</span> <span class="token operator">...</span>acc<span class="token punctuation">,</span> <span class="token operator">...</span>steps <span class="token punctuation">]</span><span class="token punctuation">;</span><br>          <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>          <span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">scannedItems<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><br>            <span class="token keyword">const</span> scanDidComplete <span class="token operator">=</span> scannedItems<span class="token punctuation">.</span>length <span class="token operator">===</span> items<span class="token punctuation">.</span>length<span class="token punctuation">;</span><br><br>            <span class="token keyword">if</span> <span class="token punctuation">(</span>scanDidComplete<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>              isFirstEmission <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span><br>            <span class="token punctuation">}</span><br>          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>        <span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><h3>Let's break it down, shall we?</h3><p>We want to keep track whether it's the first emission, or not. We only want to render lazily the first time:</p><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">let</span> isFirstEmission <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></code></pre><p>We transform the array into a stream of items:</p><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">const</span> items$ <span class="token operator">=</span> <span class="token keyword">from</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>We collect the amount of items into an array based on the concurrency:</p><pre class="language-typescript"><code class="language-typescript"><span class="token function">bufferCount</span><span class="token punctuation">(</span>concurrency<span class="token punctuation">)</span><span class="token punctuation">,</span></code></pre><p>We scheduled the rendering based on the delay, and then progressively increase the delay based on the item's index:</p><pre class="language-typescript"><code class="language-typescript"><span class="token function">concatMap</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> delayed <span class="token operator">=</span> <span class="token function">delay</span><span class="token punctuation">(</span>index <span class="token operator">*</span> delayMs<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">return</span> <span class="token function">scheduled</span><span class="token punctuation">(</span><span class="token keyword">of</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span> animationFrameScheduler<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>delayed<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>We keep collecting the processed items into a single array:</p><pre class="language-typescript"><code class="language-typescript"><span class="token function">scan</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">acc<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> steps<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> <span class="token punctuation">[</span> <span class="token operator">...</span>acc<span class="token punctuation">,</span> <span class="token operator">...</span>steps <span class="token punctuation">]</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre><p>Finally, we check if the amount of processed items is as long as the initial list. In this way, we can understand if the first emission is complete, and in case we set the flag to <code>false</code>:</p><pre class="language-typescript"><code class="language-typescript"><span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">scannedItems<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> scanDidComplete <span class="token operator">=</span> scannedItems<span class="token punctuation">.</span>length <span class="token operator">===</span> items<span class="token punctuation">.</span>length<span class="token punctuation">;</span><br><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>scanDidComplete<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    isFirstEmission <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><h2>Demo</h2><p>I came up with this because my application, Formtoro, loads quite a bit of data at startup that renders lots of Stencil components at once.</p><p>It did not work well, it was laggy. I didn't like it, so I found a way to solve it. I'll show you the differences:</p><p>Without <code>lazyArray</code> operator:</p><p><img src="/assets/images/posts/no-lazy-array.gif" alt="Without Lazy Array" loading="lazy" data-src="/assets/images/posts/no-lazy-array.gif" class="lazyload"></p><p>With <code>lazyArray</code> operator:</p><p><img src="/assets/images/posts/lazy-array.gif" alt="With Lazy Array" loading="lazy" data-src="/assets/images/posts/lazy-array.gif" class="lazyload"></p><p>This approach works very well in my case - and may not in yours. Shoot me an email if you want help implementing it. Ciao!</p><hr><p><em>If you enjoyed this article, follow me on <a href="https://twitter.com/gc_psk">Twitter</a></em></p></section><footer class="mt-5 pb-5"><a href="/">Back to home</a></footer></article></div><link href="https://fonts.googleapis.com/css2?family=Martel:wght@400;700;800&amp;display=swap" rel="stylesheet"><script>!function(){if("loading"in HTMLImageElement.prototype){var e=document.querySelectorAll("img"),t=e.length;if(0<t)for(var s=0;s<t;s++)"dataset"in e[s]&&"src"in e[s].dataset&&(e[s].src=e[s].dataset.src),"srcset"in e[s].dataset&&(e[s].srcset=e[s].dataset.srcset)}else{var a=document.createElement("script");a.async=!0,a.src="https://cdn.jsdelivr.net/npm/lazysizes@5/lazysizes.min.js",document.body.appendChild(a)}}()</script></body></html>