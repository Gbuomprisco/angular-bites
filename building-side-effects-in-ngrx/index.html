<!doctype html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="apple-touch-icon" href="/assets/images/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/images/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/images/favicon-16x16.png"><link rel="icon" href="/assets/images/favicon.ico"><title>Building Side Effects in NGRXs</title><meta name="description" content="Effects are one of the most powerful features in NGRX. Let’s see some practical examples, like calling an API or streaming real-time data"><meta name="author" content="Giancarlo Buomprisco"><meta property="og:title" content="Building Side Effects in NGRXs"><meta property="og:description" content="Effects are one of the most powerful features in NGRX. Let’s see some practical examples, like calling an API or streaming real-time data"><meta property="og:locale" content="en"><meta property="og:site_name" content="Angular Bites"><meta property="og:type" content="article"><meta name="twitter:image" property="og:image" content="https://angularbites.comhttps://cdn-images-1.medium.com/max/1600/1*R3-0VFvXB2rq-rAtWyNwxA.gif"><meta property="twitter:title" content="Building Side Effects in NGRXs"><meta property="twitter:card" content="summary_large_image"><meta property="twitter:creator" content="@gc_psk"><meta property="twitter:description" content="Effects are one of the most powerful features in NGRX. Let’s see some practical examples, like calling an API or streaming real-time data"><meta property="og:url" content="https://angularbites.com/building-side-effects-in-ngrx/"><meta property="article:published_time" content="2019-06-05T00:00:00.000Z"><script type="application/ld+json">{
"description": "Effects are one of the most powerful features in NGRX. Let’s see some practical examples, like calling an API or streaming real-time data",
"author": { "@type": "Person", "name": "Giancarlo Buomprisco" },
"@type": "BlogPosting",
"url": "https://angularbites.com/building-side-effects-in-ngrx/",
"publisher": {
"@type": "Organization",
"logo": {
"@type": "ImageObject",
"url": "https://angularbites.com/assets/images/logo.png"
},
"name": "Giancarlo Buomprisco"
},
"headline": "Building Side Effects in NGRXs",
"datePublished": "2019-06-05T00:00:00.000Z",
"mainEntityOfPage": {
"@type": "WebPage",
"@id": "https://angularbites.com/building-side-effects-in-ngrx/"
},
"@context": "http://schema.org"
}</script><link href="/assets/styles/main.35fec6ed6a4453d3d2c4.css" rel="stylesheet"></head><body><div class="container mx-auto pt-8"><header><div class="ml-5"><h1 class="text-4xl my-0"><a class="font-bold site-name flex items-center justify-center" href="/"><img class="logo" alt="Logo" src="/assets/images/logo.png"> Angular Bites</a></h1></div></header><article class="post pt-4"><header class="mb-8"><h1>Building Side Effects in NGRXs</h1><div class="block items-center md:flex justify-center"><div class="user-image flex items-center"><a target="_blank" href="https://twitter.com/@gc_psk" class="flex items-center"><img src="/assets/images/giancarlo.jpeg"> <span class="ml-2 text-gray-600 text-sm">@gc_psk</span> </a><span class="text-gray-600 text-400 ml-1">/ June 5, 2019</span></div><div class="mt-2 md:ml-5 md:mt-0"><a href="/tags/ngrx" class="tag-item text-xs">ngrx</a></div></div><div class="featured-image mb-8 mt-8 hidden md:block"><img src="https://cdn-images-1.medium.com/max/1600/1*R3-0VFvXB2rq-rAtWyNwxA.gif"></div></header><section class="pb-3"><hr><h3>Building Side Effects in NGRX</h3><p>This is the third article of a series that aims to explain in detail a step-by-step approach to building an Angular application with NGRX.</p><ul><li>In <a href="https://medium.com/r/?url=https%3A%2F%2Fitnext.io%2Fstate-management-with-ngrx-introduction-1aae0803e988">the first article of this series</a>, I wrote a small overview of all the concepts surrounding the NGRX platform.</li><li>In <a href="https://medium.com/r/?url=https%3A%2F%2Fitnext.io%2Farchitecting-the-store-in-ngrx-e4955641d746">the second article of this series</a>, I started writing the store of the application and the state’s entities.</li></ul><p>If you have never worked with NGRX, or have never done something in-depth with, I’d really recommend you read it.</p><h3>Summary</h3><p>Just to summarise what I introduced in the previous articles, we have an application that aims to display a dashboard with cryptocurrencies prices.</p><p>The application’s logic is built using three service modules, each module manages a different feature of our store.</p><p>These are:</p><ul><li><strong>dashboard</strong>, that manages the logic of the dashboard and its tiles</li><li><strong>assets,</strong> a list of assets fetched from <a href="https://medium.com/r/?url=https%3A%2F%2Fcoincap.io">Coincap’s</a> API</li><li><strong>prices,</strong> a stream of prices from Coincap’s WebSocket API</li></ul><h3>In this article we will be learning:</h3><ul><li>how to build effects in NGRX 8</li><li>how to build an effect that fetches the assets list from the API</li><li>how to build an effect that connects to a WebSocket and listens for messages that will be stored in our application’s state</li></ul><h3>Coincap’s API Service</h3><p>In order to fetch data from Coincap, we create a service that we’re going to use in our Effects classes:</p><pre class="language-typescript"><code class="language-typescript">@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">CoincapService</span> <span class="token punctuation">{</span><br>    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> http<span class="token operator">:</span> HttpClient</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><br><br>    <span class="token keyword">public</span> <span class="token function">getAssets</span><span class="token punctuation">(</span><br>        search<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>        ids<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>        limit <span class="token operator">=</span> <span class="token number">5</span><br>    <span class="token punctuation">)</span><span class="token operator">:</span> Observable<span class="token operator">&lt;</span>GetAssetsResponseDto<span class="token operator">></span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>http<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token operator">&lt;</span>GetAssetsResponseDto<span class="token operator">></span><span class="token punctuation">(</span>EndPoints<span class="token punctuation">.</span>Assets<span class="token punctuation">,</span> <span class="token punctuation">{</span><br>            params<span class="token operator">:</span> <span class="token punctuation">{</span> search<span class="token punctuation">,</span> ids<span class="token punctuation">,</span> limit<span class="token operator">:</span> limit<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><br>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><p>At the moment, we have one single method:</p><ul><li><strong>getAssets</strong>, that by default will be fetching the first top 5 assets</li></ul><p>This method will be returning <code>GetAssetsResponseDto</code> which is simply:</p><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">interface</span> <span class="token class-name">GetAssetsResponseDto</span> <span class="token punctuation">{</span><br>    data<span class="token operator">:</span> Asset<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br>    timestamp<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><h2>Assets Effects</h2><p>Let’s now create the effects for the <em>Assets</em> store. As we have seen in the previous article, we have created three actions:</p><ul><li>getAssetsRequestStarted</li><li>getAssetsRequestSuccess</li><li>addAssets</li></ul><h3>Private API</h3><p>Let’s summarize what our actions will be doing:</p><ul><li>we want to react to a <em>getAssetsRequestStarted</em> action and dispatch a <em>getAssetsRequestSuccess</em> action</li><li>once <em>getAssetsRequestSuccess</em> action is received, we will dispatch <em>addAssets</em> that gets picked up by the reducer function and add the assets to the store</li></ul><p>Let’s first create the effect that will be responsible for fetching the assets:</p><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">private</span> <span class="token function">getAllAssets</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> <span class="token function">createEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span><br>        <span class="token keyword">this</span><span class="token punctuation">.</span>actions<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><br>            <span class="token function">ofType</span><span class="token punctuation">(</span>getAssetsRequestStarted<span class="token punctuation">.</span><span class="token keyword">type</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>            <span class="token function">mergeMap</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> payload <span class="token punctuation">}</span><span class="token operator">:</span> <span class="token punctuation">{</span> payload<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span><br>                <span class="token keyword">this</span><span class="token punctuation">.</span>coincap<span class="token punctuation">.</span><span class="token function">getAssets</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><br>                    <span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">response<span class="token operator">:</span> GetAssetsResponseDto</span><span class="token punctuation">)</span> <span class="token operator">=></span> response<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span><br>                    <span class="token function">catchError</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">of</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>                <span class="token punctuation">)</span><br>            <span class="token punctuation">)</span><span class="token punctuation">,</span><br>            <span class="token function">filter</span><span class="token punctuation">(</span>Boolean<span class="token punctuation">)</span><span class="token punctuation">,</span><br>            <span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">payload<span class="token operator">:</span> Asset<span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>                <span class="token keyword">return</span> <span class="token function">getAssetsRequestSuccess</span><span class="token punctuation">(</span><span class="token punctuation">{</span> payload <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token punctuation">}</span><span class="token punctuation">)</span><br>        <span class="token punctuation">)</span><br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p><strong>Let’s break this effect down</strong></p><ul><li>instead of using the decorator <code>@Effect</code> , we simply import the function <code>createEffect</code> from <code>@ngrx/effects</code></li><li>we receive an action <code>getAssetsRequestStarted</code></li><li>we call the <code>getAssets</code> method we defined earlier in the Coincap service, and we map the stream to the result of this request</li><li>if there’s an error, we simply return <code>undefined</code> which will be filtered in the stream thanks to <code>filter(Boolean)</code></li><li>we then map the stream to the action <code>getAssetsRequestSuccess</code></li></ul><p>The second effect will be responsible for intercepting <code>getAssetsRequestSuccess</code> and simply map it to <code>addAssets</code></p><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">private</span> <span class="token function">addAssets</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> <span class="token function">createEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span><br>        <span class="token keyword">this</span><span class="token punctuation">.</span>actions<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><br>            <span class="token function">ofType</span><span class="token punctuation">(</span>getAssetsRequestSuccess<span class="token punctuation">.</span><span class="token keyword">type</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>            <span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> payload <span class="token punctuation">}</span><span class="token operator">:</span> <span class="token punctuation">{</span> payload<span class="token operator">:</span> Asset<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span><br>                <span class="token function">addAssets</span><span class="token punctuation">(</span><span class="token punctuation">{</span> payload <span class="token punctuation">}</span><span class="token punctuation">)</span><br>            <span class="token punctuation">)</span><br>        <span class="token punctuation">)</span><br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><h3>Public API</h3><p>Finally, we expose the public API:</p><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">public</span> getAllAssets$ <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getAllAssets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">public</span> addAssets$ <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addAssets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>And this is the complete snippet:</p><pre class="language-typescript"><code class="language-typescript">@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AssetsEffects</span> <span class="token punctuation">{</span><br>    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> actions<span class="token operator">:</span> Actions<span class="token punctuation">,</span> <span class="token keyword">private</span> coincap<span class="token operator">:</span> CoincapService</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><br><br>    <span class="token keyword">public</span> getAllAssets$ <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getAllAssets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">public</span> addAssets$ <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addAssets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">private</span> <span class="token function">addAssets</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> <span class="token function">createEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span><br>            <span class="token keyword">this</span><span class="token punctuation">.</span>actions<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><br>                <span class="token function">ofType</span><span class="token punctuation">(</span>getAssetsRequestSuccess<span class="token punctuation">.</span><span class="token keyword">type</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>                <span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> payload <span class="token punctuation">}</span><span class="token operator">:</span> <span class="token punctuation">{</span> payload<span class="token operator">:</span> Asset<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span><br>                    <span class="token function">addAssets</span><span class="token punctuation">(</span><span class="token punctuation">{</span> payload <span class="token punctuation">}</span><span class="token punctuation">)</span><br>                <span class="token punctuation">)</span><br>            <span class="token punctuation">)</span><br>        <span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">private</span> <span class="token function">getAllAssets</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> <span class="token function">createEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span><br>            <span class="token keyword">this</span><span class="token punctuation">.</span>actions<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><br>                <span class="token function">ofType</span><span class="token punctuation">(</span>getAssetsRequestStarted<span class="token punctuation">.</span><span class="token keyword">type</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>                <span class="token function">mergeMap</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> payload <span class="token punctuation">}</span><span class="token operator">:</span> <span class="token punctuation">{</span> payload<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span><br>                    <span class="token keyword">this</span><span class="token punctuation">.</span>coincap<span class="token punctuation">.</span><span class="token function">getAssets</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><br>                        <span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">response<span class="token operator">:</span> GetAssetsResponseDto</span><span class="token punctuation">)</span> <span class="token operator">=></span> response<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span><br>                        <span class="token function">catchError</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">of</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>                    <span class="token punctuation">)</span><br>                <span class="token punctuation">)</span><span class="token punctuation">,</span><br>                <span class="token function">filter</span><span class="token punctuation">(</span>Boolean<span class="token punctuation">)</span><span class="token punctuation">,</span><br>                <span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">payload<span class="token operator">:</span> Asset<span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>                    <span class="token keyword">return</span> <span class="token function">getAssetsRequestSuccess</span><span class="token punctuation">(</span><span class="token punctuation">{</span> payload <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>                <span class="token punctuation">}</span><span class="token punctuation">)</span><br>            <span class="token punctuation">)</span><br>        <span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><h2>Prices Effects</h2><p>In order to fetch the prices from the Coincap’s WebSocket API, we extend the Coincap service we created earlier and add a new method responsible for connecting to the price streams and returning an Observable that emits price ticks.</p><h3>WebSocket Connection</h3><p>In order to do this, we:</p><ul><li>create a connection by calling <code>WebSocket(url)</code></li><li>we create a new Observable, and inside this, we emit an event every time the WebSocket connection receives a message using the <code>onmessage</code> hook</li><li>we define the <code>unsubscribe</code> method, which will simply close the WebSocket connection</li></ul><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">CoincapService</span> <span class="token punctuation">{</span><br>    <span class="token comment">// .. other methods</span><br><br>    webSocket<span class="token operator">:</span> WebSocket<span class="token punctuation">;</span><br><br>    <span class="token keyword">public</span> <span class="token function">connectToPriceStream</span><span class="token punctuation">(</span>assets<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> Observable<span class="token operator">&lt;</span>PriceState<span class="token operator">></span> <span class="token punctuation">{</span><br>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span>assets<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Observable</span><span class="token punctuation">(</span><span class="token parameter">observer</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>            <span class="token keyword">const</span> webSocket <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>webSocket<span class="token punctuation">;</span><br><br>            webSocket<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">msg<span class="token operator">:</span> MessageEvent</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>                observer<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token punctuation">}</span><span class="token punctuation">;</span><br><br>            <span class="token keyword">return</span> <span class="token punctuation">{</span><br>                <span class="token function">unsubscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span><br>                    webSocket<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>                <span class="token punctuation">}</span><br>            <span class="token punctuation">}</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">private</span> <span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token parameter">assets<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>webSocket<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token keyword">this</span><span class="token punctuation">.</span>webSocket<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br><br>        <span class="token keyword">this</span><span class="token punctuation">.</span>webSocket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span><br>            EndPoints<span class="token punctuation">.</span>WebSocket <span class="token operator">+</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">?assets=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>assets<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><br>        <span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><h3>API</h3><p>We have created three actions:</p><ul><li>createPriceSubscription</li><li>closePriceSubscription</li><li>addPrice</li></ul><p>And this is what the effects look like:</p><pre class="language-typescript"><code class="language-typescript">@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">PricesEffects</span> <span class="token punctuation">{</span><br>    <span class="token keyword">constructor</span><span class="token punctuation">(</span><br>        <span class="token parameter"><span class="token keyword">private</span> actions<span class="token operator">:</span> Actions<span class="token punctuation">,</span><br>        <span class="token keyword">private</span> coincap<span class="token operator">:</span> CoincapService<span class="token punctuation">,</span><br>        <span class="token keyword">private</span> pricesFacade<span class="token operator">:</span> PricesFacadeService</span><br>    <span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><br><br>    createPriceSubscription$ <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createPriceSubscription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    prices$ <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getPrices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">private</span> <span class="token function">createPriceSubscription</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> <span class="token function">createEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span><br>            <span class="token keyword">this</span><span class="token punctuation">.</span>actions<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><br>                <span class="token function">ofType</span><span class="token punctuation">(</span>createPriceSubscription<span class="token punctuation">.</span><span class="token keyword">type</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>                <span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> payload <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> payload<span class="token punctuation">)</span><span class="token punctuation">,</span><br>                <span class="token function">withLatestFrom</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>pricesFacade<span class="token punctuation">.</span><span class="token function">getSubscribedAssets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>                <span class="token function">mergeMap</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span>payload<span class="token punctuation">,</span> assets<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>                    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">connectPriceStream</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">...</span>assets<span class="token punctuation">,</span> payload<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>                <span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">price<span class="token operator">:</span> PriceState</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">priceReceived</span><span class="token punctuation">(</span><span class="token punctuation">{</span> payload<span class="token operator">:</span> price <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>            <span class="token punctuation">)</span><br>        <span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">private</span> <span class="token function">getPrices</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> <span class="token function">createEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span><br>            <span class="token keyword">this</span><span class="token punctuation">.</span>actions<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><br>                <span class="token function">ofType</span><span class="token punctuation">(</span>priceReceived<span class="token punctuation">.</span><span class="token keyword">type</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>                <span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> payload <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">addPrice</span><span class="token punctuation">(</span><span class="token punctuation">{</span> payload <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>            <span class="token punctuation">)</span><br>        <span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">private</span> <span class="token function">connectPriceStream</span><span class="token punctuation">(</span><span class="token parameter">assets<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>coincap<br>            <span class="token punctuation">.</span><span class="token function">connectToPriceStream</span><span class="token punctuation">(</span>assets<span class="token punctuation">)</span><br>            <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><br>                <span class="token function">takeUntil</span><span class="token punctuation">(</span><br>                    <span class="token keyword">this</span><span class="token punctuation">.</span>actions<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">ofType</span><span class="token punctuation">(</span>closePriceSubscription<span class="token punctuation">.</span><span class="token keyword">type</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>                <span class="token punctuation">)</span><br>            <span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><p>Let’s break down the <code>createPriceSubscription$</code> effect:</p><ul><li>we receive an action <code>createPriceSubscription</code></li><li>we connect to the stream via the Coincap service, which will return an <em>Observable</em> that will emit prices</li><li>every price will create an action <code>priceReceived</code></li><li>we add a <code>takeUntil</code> operator to the price stream observable, so that every time an action <code>closePriceSubscription</code> is received, the observable will automatically be unsubscribed</li></ul><p>The <code>prices$</code> effect is fairly simple:</p><ul><li>we receive an action <code>priceReceived</code> and we map it to an action <code>addPrice</code> that will be handled by the reducer and will add the price to the store</li></ul><h3>Updating the Store Modules</h3><p>Lastly, we need to update both the store service modules by adding the effects using the method <code>EffectsModule.forFeature([EffectsClass])</code> .</p><p>The prices store module looks something like this:</p><pre class="language-typescript"><code class="language-typescript">@<span class="token function">NgModule</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>    imports<span class="token operator">:</span> <span class="token punctuation">[</span><br>        StoreModule<span class="token punctuation">.</span><span class="token function">forFeature</span><span class="token punctuation">(</span><span class="token string">'prices'</span><span class="token punctuation">,</span> pricesReducer<span class="token punctuation">)</span><span class="token punctuation">,</span><br>        EffectsModule<span class="token punctuation">.</span><span class="token function">forFeature</span><span class="token punctuation">(</span><span class="token punctuation">[</span>PricesEffects<span class="token punctuation">]</span><span class="token punctuation">)</span><br>    <span class="token punctuation">]</span><span class="token punctuation">,</span><br>    providers<span class="token operator">:</span> <span class="token punctuation">[</span><br>        <span class="token comment">// still empty!</span><br>    <span class="token punctuation">]</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><br><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">PricesStoreModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><h2>Final Words</h2><p>In this walkthrough, we create a few very simple effects that do some very common tasks, such as talking to an API endpoint, creating streams of Observables from real-time messaging systems, and updating the reducer as a result of dispatching actions.</p><p>In the next article, we will finally build some components and connect the store to the UI using a Facade Service.</p><p>Hope you enjoyed the article and leave a message if you agree, disagree, or if you would do anything differently!</p><hr><p><em>If you enjoyed this article, follow me on</em> <a href="https://medium.com/@.gc"><em>Medium</em></a> <em>or</em> <a href="https://medium.com/r/?url=https%3A%2F%2Ftwitter.com%2Fhome"><em>Twitter</em></a> <em>for more articles about Angular, RxJS, Typescript and more!</em></p></section><div><script async data-uid="3e3126f064" src="https://thoughtful-inventor-7842.ck.page/3e3126f064/index.js"></script></div><div class="text-sm mt-2">Do you want to report something incorrect? Please open an Issue or a PR on <a class="underline" href="https://github.com/Gbuomprisco/angularbites.com">Github</a></div><footer class="mt-5 pb-5 mb-10"><a class="underline" href="/">Back to home</a></footer></article></div><script async src="https://www.googletagmanager.com/gtag/js?id=UA-172483071-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-172483071-1")</script><link href="https://fonts.googleapis.com/css2?family=Martel:wght@400;700;800&display=swap" rel="stylesheet"></body></html>